# 告警推送配置指南

本文档介绍了如何配置告警推送功能，包括 PushPlus 推送配置以及告警系统的工作原理。

## 1. 推送渠道概述

系统支持多种告警推送渠道，目前主要集成了 PushPlus 服务，可以将告警信息推送到微信。

### PushPlus 介绍
PushPlus 是一个免费的消息推送服务平台，通过它可以将系统告警推送到微信。使用前需要在 PushPlus 官网注册账号获取 Token。

## 2. PushPlus 配置详解

### 2.1 访问配置界面

1. 登录系统后，进入"链路监控"
2. 点击"PushPlus配置"菜单项
3. 即可进入配置管理界面

### 2.2 基础配置项

#### 配置名称
- **说明**：为当前配置设置一个标识名称
- **用途**：便于识别和管理不同的配置
- **要求**：唯一性，不能重复

#### Token（必需）
- **说明**：PushPlus 官方提供的唯一标识
- **获取方式**：
  1. 访问 PushPlus 官网 (www.pushplus.plus)
  2. 注册账号并登录
  3. 在个人中心获取 Token
- **注意**：这是必填项，用于身份验证

#### 标题前缀（可选）
- **说明**：所有推送消息标题前会加上此前缀
- **用途**：便于区分不同系统推送的消息
- **示例**：如果设置为 "[运维系统]"，标题会变成 "[运维系统][HIGH] 节点连接超时"

#### 状态
- **说明**：控制当前配置是否启用
- **选项**：启用/禁用
- **说明**：禁用的配置不会触发任何推送

### 2.3 消息配置

#### 消息类型
- `txt`（文本消息）：纯文本格式，最基础的推送格式
- `html`（HTML消息）：支持HTML标签，可推送格式化内容
- `markdown`（Markdown消息）：支持Markdown语法，可推送富文本格式
- `json`（JSON消息）：以JSON格式推送，适用于复杂数据结构

#### 模板类型
- `告警消息模板`：预设的告警消息格式，包含告警详细信息
  - **格式**：告警类型、节点名称、严重程度、标题、描述、首次发生时间、最后发生时间等
  - **适用场景**：系统监控告警的推送
  - **示例**：
    ```
    告警类型: node_unreachable
    告警子类型: NodeUnreachable
    节点名称: WebServer01
    严重程度: HIGH
    标题: 节点连接超时
    描述: 节点 WebServer01 连接超时，请检查服务状态
    首次发生时间: 2024-01-01 10:00:00
    最后发生时间: 2024-01-01 10:05:00
    ```

- `通知消息模板`：通用的通知消息格式
  - **格式**：简化版格式，突出告警标题和基本时间信息
  - **适用场景**：一般性通知、状态变更等
  - **示例**：
    ```
    系统通知
    告警类型: node_unreachable
    节点: WebServer01
    严重程度: HIGH
    标题: 节点连接超时
    时间: 2024-01-01 10:05:00
    ```

- `自定义消息模板`：使用在"内容模板"中设置的完全自定义的消息格式
  - **格式**：完全由用户在"内容模板"中定义
  - **适用场景**：需要特殊格式或集成其他系统的场景
  - **示例**：用户可在内容模板中设置任意格式，如：
    ```
    ❗ [{severity}] {node_name} - {title}
    时间：{last_occurred}
    详情：{description}
    ```

### 2.4 内容模板

这是一个可自定义消息内容的文本框，支持变量替换，**仅在选择"自定义消息模板"时生效**：

**可用变量**：
- `{title}` - 告警标题
- `{description}` - 告警描述
- `{node_name}` - 节点名称
- `{severity}` - 严重程度
- `{alert_type}` - 告警类型
- `{first_occurred}` - 首次发生时间
- `{last_occurred}` - 最后发生时间

**示例模板**：
```
告警类型：{alert_type}
节点：{node_name}
严重程度：{severity}
时间：{last_occurred}
详情：{description}
```

**注意**：
- 当选择"告警消息模板"或"通知消息模板"时，系统会使用预设格式，此内容模板不起作用
- 只有选择"自定义消息模板"时，才会使用此处定义的模板格式

### 2.5 推送条件配置

#### 应用到所有告警
- **说明**：是否将当前配置应用于所有告警
- **选中**：所有告警都会使用此配置推送
- **未选中**：只推送指定严重程度的告警

#### 告警级别过滤
当"应用到所有告警"未选中时，可以选择特定的告警级别：
- `LOW`：低级别告警
- `MEDIUM`：中等级别告警
- `HIGH`：高级别告警
- `CRITICAL`：严重级别告警

### 2.6 推送渠道配置

#### 订阅组列表（可选）
- **说明**：将消息推送给特定订阅组的用户
- **格式**：多个订阅组ID用英文逗号分隔
- **作用**：如果不填写，消息推送给Token对应的用户（即你自己）

#### Webhook列表（可选）
- **说明**：将消息同时推送到指定的Webhook地址
- **格式**：多个Webhook URL用英文逗号分隔
- **作用**：用于集成其他系统或自动化处理

## 3. 告警推送机制

### 3.1 告警去重机制
- 系统不会对相同告警重复推送
- 只有首次检测到新告警或告警状态变化时才会推送
- 避免同一问题的重复通知骚扰

### 3.2 推送触发时机
- **告警创建**：首次检测到问题时
- **告警关闭**：问题解决时
- **告警静默/解除静默**：告警状态变化时

### 3.3 配置优先级
- 系统会使用第一个启用的配置进行推送
- 可以配置多个配置，但一次只能启用一个
- 建议只启用一个配置避免重复推送

## 4. 配置示例

### 示例1：基本配置
- **配置名称**：个人推送配置
- **Token**：[你的PushPlus Token]
- **消息类型**：txt
- **模板类型**：告警消息模板
- **应用到所有告警**：是
- 其他项可选填

### 示例2：分级推送配置
- **配置名称**：紧急告警配置
- **Token**：[你的PushPlus Token]
- **消息类型**：html
- **模板类型**：告警消息模板
- **应用到所有告警**：否
- **告警级别过滤**：HIGH, CRITICAL
- **内容模板**：自定义高优先级告警格式

## 5. 测试配置

在配置完成后，可以使用"测试"按钮验证配置是否有效：
1. 点击列表中的"测试"按钮
2. 系统会发送一条测试消息到指定的Token
3. 如果收到消息，说明配置成功

## 6. 常见问题

### Q: 我只填写Token，不填其他项可以吗？
A: 可以。只填写Token表示消息推送到你自己的微信，无需填写订阅组和Webhook。

### Q: 为什么我每分钟只收到一次告警？
A: 系统有去重机制，相同告警不会重复推送，只会推送告警创建和解决的通知。

### Q: 如何只接收重要告警？
A: 将"应用到所有告警"设为否，然后勾选"HIGH"和"CRITICAL"等级别。